# 🔹 Security: SQL Server on IaaS vs PaaS

| **Category**                             | **IaaS – SQL Server on Azure Virtual Machines (VMs)**                                                                                                                                                                                                                                                                                                                      | **PaaS – Azure SQL Database (DB) / Azure SQL Managed Instance (MI)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Authentication vs. Authorization**     | - **Authentication**: <br> • **SQL Authentication** (username/password). <br> • **Windows Authentication** via **Active Directory Domain Services (AD DS)**. <br> • Can join VM to on-prem AD for seamless single sign-on. <br> - **Authorization**: <br> • Uses classic **SQL Role-Based Access Control (RBAC)**. <br> • Server logins mapped to database users manually. | - **Authentication**: <br> • **SQL Authentication**. <br> • **Azure Active Directory (Azure AD) Authentication** (users, groups, service principals). <br> • **Managed Identities (MI)** for app-to-DB auth (no passwords). <br> • **Windows Authentication** only in **Managed Instance (MI)** via **Azure AD Domain Services (Azure AD DS)**. <br> - **Authorization**: <br> • **SQL RBAC** + **Azure AD RBAC** for centralized governance. <br> • Supports **Conditional Access, Multi-Factor Authentication (MFA), Privileged Identity Management (PIM)**. |
| **Authentication Options**               | - SQL Authentication. <br> - Windows Authentication (Kerberos/NTLM). <br> - AD Integrated Authentication for domain-joined VMs.                                                                                                                                                                                                                                            | - SQL Authentication. <br> - Azure AD Authentication (passwordless, FIDO2, MFA, Conditional Access). <br> - Azure AD Service Principals. <br> - Managed Identities (MI).                                                                                                                                                                                                                                                                                                                                                                                       |
| **Authorization Framework**              | - Purely SQL-centric RBAC. <br> - **Server Roles** + **Database Roles**. <br> - No integration with Azure RBAC.                                                                                                                                                                                                                                                            | - SQL RBAC + Azure AD RBAC. <br> - Azure AD Groups mapped directly to database roles. <br> - Central identity governance with Conditional Access, JIT access, Identity Protection.                                                                                                                                                                                                                                                                                                                                                                             |
| **Security Principals & Access Control** | - Principals: SQL logins, Windows logins, server roles (e.g., sysadmin). <br> - Access control managed entirely inside SQL Server.                                                                                                                                                                                                                                         | - Principals: SQL logins, Azure AD users, Azure AD groups, Azure AD service principals, Managed Identities. <br> - Centralized identity management with fewer local logins.                                                                                                                                                                                                                                                                                                                                                                                    |
| **Database & Server Roles**              | - **Server Roles**: sysadmin, serveradmin, securityadmin, dbcreator, etc. <br> - **Database Roles**: db\_owner, db\_datareader, db\_datawriter, db\_ddladmin. <br> - Custom roles possible.                                                                                                                                                                                | - **Server Roles**: Limited (sysadmin not fully exposed). <br> - **Database Roles**: db\_owner, db\_datareader, db\_datawriter, db\_ddladmin, custom roles. <br> - Azure AD users/groups can be assigned to roles directly.                                                                                                                                                                                                                                                                                                                                    |
| **Permissions Management**               | - Managed in **SQL Server Management Studio (SSMS)** or T-SQL (`GRANT`, `DENY`, `REVOKE`). <br> - Full server + database permissions available.                                                                                                                                                                                                                            | - Managed via **SSMS**, **Azure Portal**, or T-SQL. <br> - Same DB-level permissions. <br> - Some server-level permissions restricted. <br> - Azure AD centralizes user/group permission assignments.                                                                                                                                                                                                                                                                                                                                                          |
| **Database & Object-Level Permissions**  | - Full control: `GRANT`, `DENY`, `REVOKE` on schemas, tables, views, stored procedures, objects. <br> - Configurable via SSMS GUI or T-SQL.                                                                                                                                                                                                                                | - Same DB object permission model. <br> - **Some system DBs and server-level objects locked** in SQL Database. <br> - Managed Instance closer to IaaS flexibility.                                                                                                                                                                                                                                                                                                                                                                                             |
| **Encryption Mechanisms**                | - **Transparent Data Encryption (TDE)** (manual enable). <br> - **Always Encrypted** (column-level). <br> - **Cell-level encryption** with certs/keys. <br> - **Backup encryption**. <br> - **SSL/TLS in transit** (optional).                                                                                                                                             | - **TDE enabled by default**. <br> - **Customer-Managed Keys (CMK)** via **Azure Key Vault**. <br> - **Always Encrypted with secure enclaves** (preview). <br> - **Dynamic Data Masking (DDM)**. <br> - **Row-Level Security (RLS)**. <br> - TLS enforced by default (cannot disable).                                                                                                                                                                                                                                                                         |
| **Firewall & Network Security**          | - **Network Security Groups (NSG)** on VM subnet. <br> - Windows Firewall inside VM. <br> - SQL Server firewall rules (manual). <br> - VPN or **Azure ExpressRoute** for hybrid security.                                                                                                                                                                                  | - Built-in **DB firewall rules** (server + DB level). <br> - **Virtual Network (VNet) Service Endpoints**. <br> - **Private Link** (private IP only). <br> - NSGs still apply if inside VNet. <br> - Azure AD Conditional Access (MFA, compliant devices).                                                                                                                                                                                                                                                                                                     |
| **Advanced Security Features**           | - Patching responsibility lies with customer. <br> - Vulnerability assessment + auditing manual or via **Azure Defender for SQL on VMs**. <br> - Custom logging with Extended Events or third-party SIEM.                                                                                                                                                                  | - **Azure Defender for SQL (formerly ATP)**: anomaly detection, vulnerability assessment, advanced threat alerts. <br> - **SQL Auditing** to Blob/Event Hub/Log Analytics. <br> - **Automatic patching & updates** by Microsoft. <br> - Built-in integration with **Microsoft Sentinel (SIEM)**.                                                                                                                                                                                                                                                               |

---

# ⚡ SQL Automation and Deployment: IaaS vs PaaS

| **Aspect**                                                 | **IaaS – SQL Server on Azure Virtual Machines (VMs)**                                                                                                                                                                                                                                                                                                                                            | **PaaS – Azure SQL Database (DB) / Azure SQL Managed Instance (MI)**                                                                                                                                                                                                                                                        |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Deployment Models**                                      | 1. **Manual Provisioning** – OS + SQL Server installation managed by DBA/IT team.<br>2. **Infrastructure as Code (IaC)** possible via:<br>• **ARM Templates (Azure Resource Manager)**<br>• **Bicep**<br>• **Terraform**<br>• **PowerShell DSC (Desired State Configuration)**.<br>3. Must script **SQL Server installation** + **configuration (collation, storage, service accounts, ports)**. | 1. **PaaS Provisioning** handled by Azure – only DB settings chosen.<br>2. Deployment through **ARM Templates, Bicep, Terraform, Azure CLI**.<br>3. Database creation automated using **Azure DevOps Pipelines** or **GitHub Actions**.<br>4. No need to install/patch SQL binaries; Azure abstracts OS + SQL installation. |
| **Patching & Upgrades**                                    | 1. DBA must schedule & apply:<br>• **Windows Server patches**<br>• **SQL Server Cumulative Updates (CU)** & **Service Packs (SPs)**.<br>2. Requires maintenance windows + downtime.<br>3. Can automate with **Azure Update Management** or custom scripts.                                                                                                                                       | 1. **Fully automated** by Microsoft.<br>2. SQL engine & OS patched without DBA intervention.<br>3. **Minimal downtime** with rolling upgrades.<br>4. DBA focuses only on schema changes & query-level deployments.                                                                                                          |
| **Schema & Code Deployment**                               | 1. Must script changes with **SQL Server Data Tools (SSDT)**, **Redgate SQL Change Automation**, or **DbUp**.<br>2. Deployment pipelines require custom build & release tasks.<br>3. More control but high complexity for schema drift handling.                                                                                                                                                 | 1. Native integration with **Azure DevOps** (SQL deployment tasks) and **GitHub Actions**.<br>2. Supports **DACPAC (Data-tier Application Packages)** deployments.<br>3. Schema drift detection and rollback options built-in.<br>4. Faster CI/CD integration.                                                              |
| **Automation Tools**                                       | 1. **SQL Server Agent** available for scheduling jobs (backups, index maintenance, ETL).<br>2. **Elastic Jobs** not available by default.<br>3. Custom automation via **PowerShell**, **Azure Automation Runbooks**, or **third-party tools (Redgate, Jenkins)**.<br>4. High flexibility but more management overhead.                                                                           | 1. **SQL Server Agent** not available (except in Azure SQL Managed Instance).<br>2. **Elastic Database Jobs** available for job automation across multiple DBs.<br>3. **Azure Automation**, **Logic Apps**, and **Azure Functions** integrate seamlessly.<br>4. Automated scaling & monitoring can trigger corrective jobs. |
| **Continuous Integration / Continuous Deployment (CI/CD)** | 1. Full CI/CD requires custom pipelines with:<br>• **Azure DevOps**<br>• **Jenkins**<br>• **Octopus Deploy**.<br>2. Must handle environment provisioning (VMs, storage, SQL setup) before DB deployment.<br>3. Rollback mechanisms scripted manually.                                                                                                                                            | 1. Built-in **Azure SQL Deployment Tasks** in Azure DevOps.<br>2. Database projects (.sqlproj) support incremental deployment.<br>3. Can leverage **Blue-Green Deployment** or **Canary Release** using Azure services.<br>4. Rollback and drift detection handled automatically by DACPACs.                                |
| **Infrastructure Management Overhead**                     | 1. DBA responsible for:<br>• Storage configuration<br>• Networking setup<br>• Failover clustering/availability groups.<br>2. Automation possible but complex.<br>3. Requires OS-level + SQL-level scripting.                                                                                                                                                                                     | 1. Azure handles infrastructure + high availability (HA).<br>2. DBA automates only database-level deployments, not OS or SQL binaries.<br>3. Less overhead, more focus on **DevOps-driven delivery**.                                                                                                                       |
| **Flexibility vs Standardization**                         | 1. Highly flexible:<br>• Choose custom OS, SQL version, patch level.<br>• Deploy complex multi-instance clusters.<br>• Automate niche enterprise requirements.<br>2. But slower, more error-prone.                                                                                                                                                                                               | 1. Highly standardized by Azure.<br>• Only supported SQL versions offered.<br>• Automated scaling and patching.<br>• CI/CD pipelines easier to implement.<br>2. Less flexibility in custom setups, but more **speed + resilience**.                                                                                         |

---

# ⚡ Query Performance Optimization: IaaS vs PaaS

| **Aspect**                              | **IaaS – SQL Server on Azure Virtual Machines (VMs)**                                                                                                                                                                                                                                                                       | **PaaS – Azure SQL Database (DB) / Azure SQL Managed Instance (MI)**                                                                                                                                                                                                                                     |
| --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Query Execution Plans**               | 1. Full control over **Execution Plans** via **SQL Server Management Studio (SSMS)**.<br>2. Can use **Query Store (QS)** if enabled manually.<br>3. Manual tuning using **Plan Guides** or **Forced Plan** via `sp_query_store_force_plan`.<br>4. Can rely on **third-party tools** (Redgate, SentryOne) for plan analysis. | 1. **Query Store (QS)** enabled by default.<br>2. Built-in **Automatic Plan Correction (APC)** automatically forces better execution plans.<br>3. Query performance history stored across restarts.<br>4. No third-party profiler access, but Azure Portal provides **Query Performance Insight (QPI)**. |
| **Indexing Strategies**                 | 1. DBA defines **Clustered, Non-Clustered, Filtered, Columnstore, XML, Full-Text** indexes.<br>2. **Ola Hallengren** or custom jobs required for rebuild/reorganize.<br>3. Must monitor **fragmentation** manually using `sys.dm_db_index_physical_stats`.<br>4. Mismanagement can cause I/O bottlenecks.                   | 1. **Automatic Index Tuning** – Azure SQL automatically creates/drops/rebuilds indexes.<br>2. DBA can override platform recommendations.<br>3. Index fragmentation handled via background processes.<br>4. **Hyperscale tier** supports large columnstore indexes automatically partitioned.             |
| **Parameter Sniffing & Plan Stability** | 1. Full control to fix **parameter sniffing** issues:<br>• `OPTIMIZE FOR` hints<br>• `RECOMPILE` hints<br>• **Plan Guides**<br>• Use **Optimize for Unknown**.<br>2. DBA manually manages **plan stability**.                                                                                                               | 1. **Intelligent Query Processing (IQP)** suite automatically mitigates parameter sniffing:<br>• **Adaptive Joins**<br>• **Interleaved Execution**<br>• **Table Variable Deferred Compilation**.<br>2. **Automatic Plan Correction (APC)** reduces regressions without DBA intervention.                 |
| **Statistics Management**               | 1. DBA must manage statistics:<br>• Create filtered statistics.<br>• Update statistics jobs manually.<br>• Decide sampling rate.<br>2. Improper stats lead to poor cardinality estimation.                                                                                                                                  | 1. **Automatic Statistics Update** by default.<br>2. **Incremental statistics** supported in Azure SQL Managed Instance (MI).<br>3. Platform ensures **query optimizer** has fresh stats for accurate plan generation.<br>4. Minimal DBA effort required.                                                |
| **Concurrency & Parallelism**           | 1. Full control over:<br>• **MAXDOP (Maximum Degree of Parallelism)** via `sp_configure`.<br>• **Cost Threshold for Parallelism (CTFP)**.<br>• NUMA-aware query parallelism.<br>2. Improper tuning causes **CXPACKET/CXCONSUMER waits**.                                                                                    | 1. Limited control – only **Database Scoped Configuration (DBSC)** for MAXDOP.<br>2. Azure may **override settings** in multi-tenant environments.<br>3. Defaults are optimized for typical workloads.<br>4. Less DBA micromanagement needed.                                                            |
| **Query Performance Monitoring Tools**  | 1. **SQL Server Profiler** / **Extended Events (XEvents)**.<br>2. **Dynamic Management Views (DMVs)**.<br>3. **PerfMon (Performance Monitor)** for CPU, memory, I/O.<br>4. Integration with **Azure Monitor** & custom logging.                                                                                             | 1. **Query Store (QS)** and **Query Performance Insight (QPI)** in Azure Portal.<br>2. **Intelligent Insights (II)** provides AI-driven root-cause analysis.<br>3. **Database Watcher (DW)** for lightweight tracking.<br>4. No access to low-level OS metrics.                                          |
| **Query Optimization Responsibility**   | 1. DBA-driven optimization.<br>2. Must design indexes, monitor stats, tune queries manually.<br>3. Must handle performance regressions after upgrades/patches.<br>4. Heavy reliance on DBA expertise.                                                                                                                       | 1. Platform-driven optimization with DBA override.<br>2. Azure provides **recommendations** (missing indexes, parameter issues).<br>3. Automatic plan correction + AI-driven tuning.<br>4. DBA focuses more on schema design & workload patterns than low-level tuning.                                  |

---

# ⚡ Performance & Optimization: IaaS vs PaaS

| **Topic**                                       | **IaaS – SQL Server on Azure Virtual Machines (VMs)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | **PaaS – Azure SQL Database (DB) / Azure SQL Managed Instance (MI)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ----------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Performance Optimization**                    | 1. Full control over **SQL Server (SQL)** and **Windows Server** settings.<br>2. Must optimize **TempDB placement**, **NUMA (Non-Uniform Memory Access) node alignment**, and **disk striping** for I/O throughput.<br>3. Configure instance-level settings like **Maximum Degree of Parallelism (MAXDOP)**, **Cost Threshold for Parallelism (CTFP)**.<br>4. Performance scaling requires **changing VM size** (vCPU, memory) and/or **storage upgrade**.<br>5. Ideal for **lift-and-shift** workloads requiring legacy compatibility. | 1. Optimized automatically using **Intelligent Query Processing (IQP)** suite (batch mode on rowstore, scalar UDF inlining, table variable deferred compilation, etc.).<br>2. **Automatic Tuning** with **Plan Correction** and **Automatic Index Management**.<br>3. **In-Memory OLTP (Online Transaction Processing)** available in Business Critical tier for latency-sensitive workloads.<br>4. Elastic performance scaling using **vCore** or **DTU (Database Transaction Unit)** model.<br>5. Ideal for **modern cloud-first** workloads needing elasticity. |
| **Key Performance Monitoring Tools**            | 1. **Dynamic Management Views (DMVs)** for instance-level monitoring.<br>2. **SQL Server Profiler** & **Extended Events (XEvents)** for query tracing.<br>3. **Performance Monitor (PerfMon)** counters for CPU, I/O, memory.<br>4. **Azure Monitor** & **Log Analytics Workspace** for infra + SQL telemetry.<br>5. Option for 3rd-party tools (SolarWinds DPA, Redgate, SentryOne).                                                                                                                                                   | 1. **Query Store (QS)** for query execution history, plan forcing, and regression detection.<br>2. **Intelligent Insights (II)** for root-cause detection and recommendations.<br>3. **Database Watcher (DW)** for lightweight performance tracking.<br>4. **Azure Monitor + Log Analytics** integration (SQL Metrics via Diagnostic Settings).<br>5. No access to OS-level metrics (PerfMon not available).                                                                                                                                                       |
| **Azure Configuration for Optimal Performance** | 1. Choose **VM family**: General Purpose, Memory Optimized (M-series up to 4TB RAM), Storage Optimized (Lsv3), HPC (High Performance Compute), GPU (N-series).<br>2. Configure **Azure Premium SSD / Ultra Disk** with caching (ReadOnly/None).<br>3. Use **Accelerated Networking** for lower latency.<br>4. Consider **Proximity Placement Groups (PPG)** for low-latency between app + DB VMs.<br>5. Manually optimize storage throughput and VM SKU to match workload.                                                              | 1. Choose **Service Tier**:<br>• **General Purpose (GP)** – Remote Azure Premium storage.<br>• **Business Critical (BC)** – Local SSDs, low latency, Always On replicas.<br>• **Hyperscale (HS)** – Distributed storage/compute for >100TB.<br>2. Scale up/down compute in seconds by changing **vCore (Virtual Core)** count.<br>3. Scale out read-only replicas for reporting in **Hyperscale** & **Business Critical** tiers.<br>4. No need to configure storage IOPS manually – managed by Azure.                                                              |
| **MAXDOP (Maximum Degree of Parallelism)**      | 1. Fully configurable at **instance-level** via `sp_configure`.<br>2. Must align with **NUMA topology** to avoid **CXPACKET / CXCONSUMER waits**.<br>3. DBA responsible for **Cost Threshold for Parallelism** + `MAXDOP` best practices.<br>4. Misconfiguration can degrade performance significantly.                                                                                                                                                                                                                                 | 1. Configurable only at **Database Scoped Configuration (DBSC)** level.<br>2. **Platform may override** values in multi-tenant scenarios for stability.<br>3. Reduced DBA control compared to IaaS.<br>4. Most workloads run fine with default platform-optimized settings.                                                                                                                                                                                                                                                                                        |
| **Database Maintenance & Automation**           | 1. Manual **index rebuild/reorganize** (scripts like Ola Hallengren).<br>2. Manual **statistics update** jobs.<br>3. **SQL Server Agent** for automation (or Elastic Jobs if extended).<br>4. Full control over **backup/restore strategies**: Full, Differential, Transaction Log (to Blob storage or file share).<br>5. Manual **patching & upgrades** for OS and SQL.                                                                                                                                                                | 1. Automated **index tuning** (create/drop/repair).<br>2. Automatic **statistics updates**.<br>3. **Automatic backups** (Point-In-Time Restore, Geo-Redundant Backup).<br>4. **Automated patching** of underlying OS + SQL engine with minimal downtime.<br>5. DBA focuses only on **logical tuning** (query optimization, schema design), not infra maintenance.                                                                                                                                                                                                  |

# 🔹 Migration to Azure SQL – IaaS vs PaaS

## **1. Migration to IaaS (SQL Server on Azure VMs)**

👉 Basically a **lift-and-shift** approach. You’re just moving your existing SQL Server into an Azure VM.

| Aspect             | IaaS Migration                                                                                                                                                                                                                                                                       |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Strategy**       | ✅ *Rehost* (Lift-and-shift) <br> ✅ *Replatform* (minimal changes, e.g. disks/storage config)                                                                                                                                                                                         |
| **Typical Tools**  | - **Azure Migrate** (for VM discovery & lift-and-shift) <br> - **Backup/Restore** (native SQL backup to Azure Blob, then restore on VM) <br> - **Log Shipping** (for cutover with minimal downtime) <br> - **Database Mirroring / Always On AGs** (sync databases before switchover) |
| **Pros**           | - Fastest migration path <br> - Full SQL feature support (Agent jobs, SSIS, cross-DB queries, CLR, etc.) <br> - Minimal app changes                                                                                                                                                  |
| **Cons**           | - You still manage OS, patching, HA/DR setup <br> - Not fully “cloud native” <br> - Higher TCO if not optimized                                                                                                                                                                      |
| **When to Choose** | - If you need **full SQL feature parity** (e.g., SSRS, SSAS, cross-instance features) <br> - Legacy apps tightly coupled with SQL Server <br> - Quick lift needed with minimal code change                                                                                           |

---

## **2. Migration to PaaS (Azure SQL Database / Managed Instance)**

👉 Here you’re **replatforming/refactoring** because PaaS doesn’t support every SQL feature.

| Aspect             | PaaS Migration                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Strategy**       | ✅ *Replatform* (DB schema + data move to PaaS) <br> ✅ *Refactor* (app code changes if features unsupported)                                                                                                                                                                                                                                                                                                  |
| **Typical Tools**  | - **Data Migration Assistant (DMA)** → Assess compatibility, find unsupported features <br> - **Azure Database Migration Service (DMS)** → Online/offline migrations <br> - **BACPAC Export/Import** → Schema + data export (good for smaller DBs) <br> - **Transactional Replication** → Push data into Azure SQL DB <br> - **Log Replay Service (MI only)** → Continuous log shipping for large migrations |
| **Pros**           | - Fully managed (HA, backups, patching) <br> - Lower TCO, elastic scaling <br> - Cloud-native features (geo-replication, serverless, hyperscale)                                                                                                                                                                                                                                                             |
| **Cons**           | - Limited SQL features (no SQL Agent in SQL DB, limited cross-db queries, some CLR/SSRS not supported) <br> - App refactoring may be required <br> - Migration effort higher                                                                                                                                                                                                                                 |
| **When to Choose** | - If you want **minimal ops overhead** <br> - Apps can work within **PaaS limitations** <br> - Need cloud-native scaling (Hyperscale, serverless) <br> - Targeting SaaS, multi-tenant, or modern workloads                                                                                                                                                                                                   |

---

# 🔹 Side-by-Side Migration Comparison

| Factor                   | **IaaS Migration**                                     | **PaaS Migration**                                                   |
| ------------------------ | ------------------------------------------------------ | -------------------------------------------------------------------- |
| **Approach**             | Rehost (lift-and-shift)                                | Replatform / Refactor                                                |
| **Tools**                | Azure Migrate, Backup/Restore, Log Shipping, AGs       | DMA, DMS, BACPAC, Transactional Replication, Log Replay Service      |
| **Downtime Options**     | Offline (backup/restore), near-zero (AG, log shipping) | Offline (bacpac), near-zero (DMS online, replication, log replay MI) |
| **Feature Parity**       | 100% (depends on SQL edition chosen)                   | Limited (depends: SQL DB vs MI; some features missing in SQL DB)     |
| **Operational Overhead** | High (you patch, backup, HA/DR)                        | Low (MS manages infra, HA, backups)                                  |
| **Best For**             | Quick lift with minimal code change                    | Modernization, long-term cloud-native goals                          |
| **Gotchas**              | Need to set up HA/DR manually, cost of large VMs       | Unsupported features may block migration, app rewrites needed        |

---

# 🔹 Azure Connectivity Options (When to Use Which)

| Option                                            | What It Is                                                                                                                                                                          | When to Use                                                                                                                                                                          | Key Points                                                                                                                                                                                                                   | Example Scenario                                                                                                                                                     |
| ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **VPN Gateway** (Virtual Private Network Gateway) | An Azure resource that provides **site-to-site (S2S)**, **point-to-site (P2S)**, or **VNet-to-VNet** connectivity using **encrypted tunnels (IPsec/IKE)** over the public internet. | Use when you need **secure hybrid connectivity** from on-premises to Azure OR between VNets, but **internet-based encryption is acceptable** (lower cost than ExpressRoute).         | - Works over internet (encrypted). <br> - Bandwidth lower than ExpressRoute (up to \~10 Gbps with aggregation). <br> - Good for dev/test or smaller workloads. <br> - Supports both IaaS (VMs) and PaaS (SQL DB, MI).        | You have an on-premises SQL Server and want to migrate/test against Azure SQL Database with secure connectivity, but don’t want to pay for ExpressRoute.             |
| **ExpressRoute Gateway**                          | A gateway that connects Azure VNets to **on-premises networks via dedicated private fiber circuits** provided by telco partners.                                                    | Use when you need **dedicated, private, high-throughput, low-latency connection** between on-premises and Azure for mission-critical workloads with **compliance/regulatory** needs. | - Completely bypasses internet. <br> - High reliability and predictable performance. <br> - Expensive compared to VPN. <br> - Supports connectivity to **Azure SQL Database, Managed Instance, and SQL Server in IaaS VMs**. | A bank requires direct, private connectivity from its datacenter to Azure SQL Managed Instance to meet compliance (no internet routing).                             |
| **Service Endpoint**                              | Extends **VNet identity (subnet)** to Azure services over Microsoft’s backbone, but still uses the **public endpoint** of the service.                                              | Use when you want **simpler subnet-based access control** to PaaS services, but are **okay with public endpoints still being in play**.                                              | - Improves routing performance (uses Microsoft backbone). <br> - Restricts access at **subnet level**. <br> - Still subject to public endpoint exposure. <br> - Easier to configure than Private Link.                       | A web app on VM inside VNet1 should only access Azure SQL Database from subnet 10.0.0.0/24 and block all other traffic. Service Endpoints can enforce this.          |
| **Private Link**                                  | Provides **private IP addresses inside a VNet** that map directly to PaaS services (like Azure SQL Database).                                                                       | Use when you must **completely disable public endpoints** and require **highest data exfiltration protection**.                                                                      | - Strongest security: service accessible only via private IP. <br> - Blocks all public traffic. <br> - Requires more setup than Service Endpoint. <br> - Best for zero-trust and compliance.                                 | A healthcare app’s VM in VNet1 must connect to Azure SQL Database with **no public exposure at all**; Private Link ensures SQL DB gets a private IP inside the VNet. |

---

### 🔑 Quick “When to Use” Summary

* **VPN Gateway** → Use for secure hybrid connectivity (encrypted tunnel over internet).
* **ExpressRoute Gateway** → Use for dedicated private circuit with high bandwidth & compliance.
* **Service Endpoint** → Use when you want to restrict access by VNet/subnet but can still tolerate public endpoint.
* **Private Link** → Use when you must kill public endpoints and route through private IP only.

---

# 📘 Query Store Cheat Sheet (Azure SQL Database)

---

## 🔹 1. What Query Store Does

* Captures query **execution plans** and **runtime stats** over time.
* Helps analyze **performance regressions**, **plan changes**, and **slow queries**.
* Persists across restarts (unlike DMVs).

---

## 🔹 2. Query Store States

* **Read-Write** → Normal, captures data.
* **Read-Only** → Captures stop, you can still query history.
* **Off** → Disabled.

### Why Query Store goes **Read-Only**

1. Database runs out of space for Query Store.
2. Data flushes from memory to disk take too long.
3. IO or resource pressure.

👉 **Fix:** Adjust flush interval, increase database size, or clean old data.

---

## 🔹 3. Key Configuration Settings

* **Operation Mode**:

  * Off / Read-Only / Read-Write
* **Data Flush Interval** (default: 15 min):

  * How often in-memory stats get written to disk.
  * 🏆 *Reduce this to prevent read-only transitions.*
* **Statistics Collection Interval** (default: 1 hr):

  * Controls aggregation of runtime stats, not related to read-only.
* **Max Size (MB)**:

  * Cap for Query Store data. If reached → goes Read-Only.
* **Stale Query Threshold (days)**:

  * Auto-cleanup of old query data.

---

## 🔹 4. Monitoring Query Store

* **DMVs**:

  * `sys.database_query_store_options` → Current settings.
  * `sys.query_store_runtime_stats` → Runtime stats.
  * `sys.query_store_plan` → Plans captured.
  * `sys.query_store_query_text` → Query text.

* **Query Performance Insight (QPI)** in Azure Portal:

  * High CPU, IO-heavy queries, regressed queries.

* **Extended Events / DMVs** → Deep diagnostics.

---

## 🔹 5. Query Store Use Cases in Exams

1. **Identify if tempdb is a bottleneck** → Use **DMVs**.
2. **Identify top resource-consuming queries** → Use **Query Performance Insight**.
3. **Prevent Query Store going Read-Only** → Decrease **Data Flush Interval**.
4. **Capture query regressions** → Use **Query Store forced plan**.
5. **Turn on Query Store** → `ALTER DATABASE SET QUERY_STORE = ON`.

---

## 🔹 6. Best Practices

* Keep **flush interval low** (5–10 min) for high workload DBs.
* Set **Max Size (MB)** high enough for workload.
* Use **cleanup policies** to purge old/stale queries.
* Use **forced plans** carefully (good for regressions, risky for evolving workloads).

---

## 🔹 7. Example Questions & Traps

**Q: Query Store keeps going read-only due to disk pressure. What do you do?**

* Increase DB size or set cleanup policies.

**Q: You need to track query regressions after patching. What feature?**

* Query Store forced plans.

**Q: How to detect top queries consuming CPU?**

* Query Performance Insight.

**Q: Which interval affects Query Store write pressure?**

* Data Flush Interval (NOT Statistics Interval).

---

🔥 With this, if you see *"Query Store + read-only + interval"* → Always **Data Flush Interval**.
If you see *"Identify top queries"* → **QPI (Query Performance Insight)**.
If you see *"Deep troubleshooting"* → **DMVs**.

